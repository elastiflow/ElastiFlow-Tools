#!/bin/bash

flow_config_path="/etc/elastiflow/flowcoll.yml"

# Extract elastic password from flowcoll config
elastic_password=$(grep "^EF_OUTPUT_ELASTICSEARCH_PASSWORD: '" "$flow_config_path" | awk -F"'" '{print $2}')

if [[ -z "$elastic_password" ]]; then
  echo "ERROR: Could not extract EF_OUTPUT_ELASTICSEARCH_PASSWORD from $flow_config_path" >&2
  exit 1
fi

# Attempt to get the disk usage percent
USAGE_PERCENT=$(curl -s -f -u elastic:"$elastic_password" https://localhost:9200/_cat/allocation?v --insecure | awk 'NR==2 {print $9}')

# Check if curl or awk failed or if output is empty/non-numeric
if [[ $? -ne 0 || -z "$USAGE_PERCENT" || ! "$USAGE_PERCENT" =~ ^[0-9]+$ ]]; then
  echo "ERROR: Failed to retrieve disk usage percent from Elasticsearch." >&2
  exit 1
fi

echo "Disk usage is $USAGE_PERCENT%"


/////////

#!/bin/bash

flow_config_path="/etc/elastiflow/flowcoll.yml"

# Extract opensearch password from flowcoll config
opensearch_password=$(grep "^EF_OUTPUT_OPENSEARCH_PASSWORD: '" "$flow_config_path" | awk -F"'" '{print $2}')

if [[ -z "$opensearch_password" ]]; then
  echo "ERROR: Could not extract EF_OUTPUT_OPENSEARCH_PASSWORD from $flow_config_path" >&2
  exit 1
fi

# Attempt to get the disk usage percent
USAGE_PERCENT=$(curl -s -f -u admin:"$opensearch_password" https://localhost:9200/_cat/allocation?v --insecure | awk 'NR==2 {print $6}')

# Check if curl or awk failed or if output is empty/non-numeric
if [[ $? -ne 0 || -z "$USAGE_PERCENT" || ! "$USAGE_PERCENT" =~ ^[0-9]+$ ]]; then
  echo "ERROR: Failed to retrieve disk usage percent from OpenSearch." >&2
  exit 1
fi

echo "Disk usage is $USAGE_PERCENT%"
